{% extends "eden-base.html" %}

{% block ie_hack %}
  <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9">
  <!--[if IE]>
  <script type="text/javascript" src="{{ STATIC_URL }}js/excanvas.js"></script>
  <![endif]-->
{% endblock ie_hack %}

{% block title %}EDEN Timeseries Data{% endblock title %}

{% block script %}
	<script type="text/javascript" src="{{ STATIC_URL }}js/dygraph-combined.js"></script>
{% endblock script %}

{% block style %}
<style>
{% for c in color_list %}
.color_{{ forloop.counter0 }} {
  color: {{ c }} !important; }
{% endfor %}
#hydrograph_form p {
  white-space: pre-wrap; }
</style>
{% endblock style %}

{% block content_header %}
  <h2>Explore and View EDEN (EVE)</h2>
  <p>EVE allows users to graph and download data for multiple gages and multiple parameters.</p>
{% endblock content_header %}

{% block content %}
<div style="position: relative; min-width: 750px; white-space: nowrap; " id="content-block">
<div class="form_input_field" style="vertical-align: top; display: inline-block; float: left; margin-bottom: 5px;">
	<form name="hydrograph_query" id="hydrograph_form" method="GET" action="">
	{# if method="POST", add this tag: {% csrf_token %} #}
		<div class="form_error">{{ query_form.non_field_errors }}</div>
		<div class="form_error">{{ query_form.field_errors }}</div>
		<table width="150" border="2" cellspacing="0" cellpadding="1" bgcolor="#4b7e83" align="left">
            <tr class="grtablehead">
                <th>Timeseries</th>
            </tr>
            <tr>
                <td align="left" class="gtablecell" valign="top">
                {{ query_form.timeseries_start.errors }}
                    <label for="{{ query_form.timeseries_start.html_name }}"><strong>Start: </strong></label>{{ query_form.timeseries_start }}<br />
                 {{ query_form.timeseries_end.errors }}
                    <label for="{{ query_form.timeseries_end.html_name }}"><strong>End: &nbsp;</strong></label>{{ query_form.timeseries_end }}<br />
                </td>
            </tr>
                      
            <tr class="grtablehead">
                <th><label for="{{ query_form.site_list.html_name }}">Site List</label></th>
            </tr>
            <tr class="gtablecell2">
                <td style="font-size: 75%;" align="center">Select multiple gages by<br>holding the control (PC)<br>or command (Mac) key.</td>
            </tr>
		    <tr>
                <td align="center" class="gtablecell">
				{{ query_form.site_list }}	
                </td>
            </tr>
		
		<tr>
            <td align="center" class="gtablecell2"><input name="hydrograph_query" type="submit" value="Update Graph" style="font-size: 18px; font-family: arial,helvetica,sans-serif;"></td>		
        </tr>
           
{% if plot_params %}
        <tr class="pwtablehead">
            <th></th>
        </tr>
        <tr class="pwtablehead">
            <th>Download</th>
        </tr>
        <tr class="pwtablehead">
            <th></th>
        </tr>
        <tr class="gtablecell2">
            <td style="font-size: 75%; white-space: nowrap;" align="center">(for stations selected above)</td>
        </tr>
        
		<tr>
            <td class="gtablecell">
                <!-- TODO Disable the next if selection period is longer than a year -->
                - <a href="{% url dj_eden_app.views.data_views.hourly_download %}?{{ plot_params }}">Hourly Data</a><br />
                - <a href="{% url dj_eden_app.views.data_views.daily_download %}?{{ plot_params }}">Daily Averages</a><br />
                - <a href="{% url dj_eden_app.views.data_views.plot_image_auto %}?{{ plot_params }}">High-quality Graph</a><br />
            </td>
        </tr>
{% else %}
        <tr>
            <td>
                <p>After site selection and update, data download will be available here.</p>
            </td>
        </tr>
{% endif %}

		</table>
	</form>
</div>
<div style="float: left; width: 70%;">
	<div>
	<div class="gtablecell" style="border: solid; float: left; margin-left: 5px; padding: 3px; width: 130px;">
	   <strong>Data Selected</strong><br />{% for g in gages %}
	       <br />{{ g }}
	   {% endfor %}
  </div>
<!-- TODO dynamic height for legend -->
{% if plot_params %}
	<div id="dynamic_legend" style="border: 2px white solid; width: 150px; float: left; padding: 3px;"></div>
	<div id="hydrograph_legend" style="border:solid; width: 240px; padding: 3px; float: left;">
	   <table>
	   {% for g in gages %}
	       <tr class="color_{{ forloop.counter0 }}"><td>&nbsp;&mdash;&mdash;&mdash;</td><td class="gtablecell">{{ g }}</td></tr>
	   {% endfor %}
        <!-- <tr><td colspan="2">&mdash;</td></tr> -->
        <tr><td><img src="{{ STATIC_URL }}images/line-solid.png" alt="solid line" /></td><td class="gtablecell">Observed data</td></tr>
        <tr><td><img src="{{ STATIC_URL }}images/line-dotted.png" alt="dotted line" /></td><td class="gtablecell">Estimated data</td></tr>
        <tr><td><img src="{{ STATIC_URL }}images/line-dashed.png" alt="dashed line" /></td><td class="gtablecell">Data in "dry" range</td></tr>
        </table>
	</div>
	</div>
	<div id="graph" class="dygraph_plot"></div>
	<noscript>
	    <img id="eden_plot" src="{% url dj_eden_app.views.data_views.plot_image_auto %}?no_logo&{{ plot_params }}" />
	</noscript>
	</div>
</div>    

	<p style="font-size: 75%; clear: left;">Tip: Left-click and drag in the plot to zoom.</p>
	<p style="font-size: 75%;">Tip: Option-click and drag in the plot to pan.</p>
	<p style="font-size: 75%;">Tip: To reset zoom to full selected period, double left-click in the plot.</p>

    <script type="text/javascript">
        var color_base = {{ colors }};

    function hex2rgb(hx) {
        var re = /^#(\w{2})(\w{2})(\w{2})$/;
        var bits = re.exec(hx);
        if (bits) {
            
            var r = parseInt(bits[1], 16);
            var g = parseInt(bits[2], 16);
            var b = parseInt(bits[3], 16);
            
            return {"r":r, "g":g, "b":b};
        } else {
            return null;
        }
    }
    
    function soften(hx, alpha) {
        var rgb = hex2rgb(hx);
        
        return "rgba("+rgb.r+","+ rgb.g+","+ rgb.b+","+ alpha+")";
    }
    
    
        var colors3 = [];
        var i;
        for (i = 0; i < color_base.length; i++) {
            // copy in triplicate to account for 3 lines per gage
            colors3.push(color_base[i]);
            // Soften color for next two entries to distinguish from observed data
            colors3.push(soften(color_base[i], 0.5));  
            colors3.push(soften(color_base[i], 0.5));
        }
        
    	var dateStart = "{{ str_tstart|safe }}";
    	var dateEnd = "{{ str_tend|safe }}";
    	var ngvd29Conversion = {{ ngvd29_correction }};
    	
    	var seriesOptions = {{ series_options }};
    	
    	// dry_elevation and ground_elevation line for single gage
    	var dryElevation = {{ dry_elevation }};
    	var groundElevation = {{ ground_elevation }};

    	
    	// note auto gear shift for daily/hourly
    	

         var g2 = new Dygraph(
           document.getElementById("graph"),
           "{% url dj_eden_app.views.data_views.plot_data_auto %}?{{ plot_params }}",
           {
            ylabel: "Water Level (NAVD88 ft)",
            xlabel: "Date",
            y2label: "Water Level (NGVD29 ft)",
            yAxisLabelWidth: 60,
            strokeWidth: 1.0,
            colors: colors3,
            {% if ngvd29_series != None and ngvd29_correction != None %} //tried this with JS if statement... using Django templating until I can figure it out...
            drawCallback: function(dygraph, isInitial) {
    			if (isInitial) {
    			 labels = dygraph.getLabels();
    			 labelToMove = labels[3];
    			console.log("series: " + labelToMove);
    			yrange = dygraph.yAxisRange();
    			//resize(100, 100);
    			yrange[0] -= ngvd29Conversion;
    			yrange[1] -= ngvd29Conversion;
    			newOptions = { 
    			   axes: {y2: { valueRange: yrange} } 
    			};
    			newOptions[labelToMove] = {axis: 1};

    			console.log("new options " + newOptions);
    			dygraph.updateOptions(newOptions);
    			props = dygraph.getPropertiesForSeries(labelToMove);
    			console.log(labelToMove + " on axis " + props['axis']);
    			}
    },
    			{% endif %}
 				series: seriesOptions,
 				
            // options for dynamic legend
                // hideOverlayOnMouseOut: false,
                // legend: 'always',
                labelsDiv: 'dynamic_legend',
                
            // range selector (overview graph)
{% if DYGRAPH_RANGE_SELECTOR %}
                showRangeSelector: true,
                interactionModel: Dygraph.defaultInteractionModel,
{% endif %}

            {% if str_tstart != None and str_tend != None %}
            dateWindow: [ Date.parse( dateStart ),
                          Date.parse( dateEnd )
                         ],
            {% endif %}
            underlayCallback: function(canvas, area, g) {
              if (dryElevation != null) {
                var top_right = g.toDomCoords(0, dryElevation);

                var top = top_right[1];

                canvas.fillStyle = "rgba(128, 128, 128, 0.5)";
                canvas.fillRect(area.x, top, area.w, 4);
              }
              
              if (groundElevation != null) {
                var top_right = g.toDomCoords(0, groundElevation);

                var top = top_right[1];

                canvas.fillStyle = "brown";
                canvas.fillRect(area.x, top, area.w, 4);
              }
            },
            // labelsDiv: document.getElementById('hydrograph_legend'),
            labelsSeparateLines: true,
            // legend: 'always',
            
            drawPoints: true   // Look, no trailing comma; make IE happy.
           }          // options
         );
                  
    </script>

{% else %}
	   <p>After site selection, a graph will be displayed here.</p>
{% endif %}

{% endblock content %}