import re
import MySQLdb as mdb
import sys

db_host = '127.0.0.1'
db_user = 'root'
db_password = 'Syv30V3cHP'
db_schema = 'eden_mock'

try:
	con = None

	con = mdb.connect(db_host, db_user, db_password, db_schema);

	cur = con.cursor()

	cur.execute("select * from timeseries limit 1")
	
	onion = ''

	view = "create view stage_view as \n"

	pat = re.compile('stage_(.+)')

	for i in cur.description:
		name = i[0]
		m = pat.match(name)
		if m :
			stn = m.group(1)
			view += onion
			view += "(select '%s' as station, datatime as datatime, stage_%s as stage, flag_%s as flag from timeseries)\n" % (stn, stn, stn)
			onion = " union\n"
	print view
except mdb.Error, e:
	print "Error %d: %s" % (e.args[0],e.args[1])
	sys.exit(1)
finally:
	if con:
		con.close()
